<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgriSmart Pro | Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #0b0d17; color: #fff; overflow-x: hidden; }
    .live-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(125deg, #0b0d17, #1a1000, #000, #141e30); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: -2; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 50px; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255, 106, 0, 0.2); position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 24px; font-weight: bold; color: #ff6a00; }
    .namaste-text { color: #ff6a00; font-weight: bold; margin-right: 15px; }
    .logout-btn { background: transparent; border: 1px solid #ff6a00; color: #ff6a00; padding: 5px 15px; border-radius: 20px; cursor: pointer; }

    .features-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; padding: 50px; }
    .feature-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); padding: 30px; border-radius: 24px; text-align: center; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s; }
    .feature-card:hover { transform: translateY(-5px); border-color: #ff6a00; }
    .feature-card i { font-size: 45px; color: #ff6a00; margin-bottom: 15px; }

    #dashboard-view { margin: 0 50px 50px; padding: 50px; background: rgba(10, 10, 10, 0.8); border-radius: 35px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; min-height: 250px; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left; }
    .data-table th { color: #ff6a00; padding: 10px; border-bottom: 1px solid #333; }
    .data-table td { padding: 10px; border-bottom: 1px solid #222; }
</style>
</head>
<body>
<div class="live-bg"></div>
<div class="navbar">
    <div class="logo">ðŸŒ¾ AgriSmart Pro</div>
    <div class="nav-right" id="nav-user"></div>
</div>
<div class="features-container">
    <div class="feature-card" onclick="showView('market')"><i class="fas fa-chart-line"></i><h3>Market Prices</h3><p>Live Mandi Rates</p></div>
    <div class="feature-card" onclick="showView('weather')">
    <i class="fas fa-cloud-sun-rain"></i>
    <h3>Weather Hub</h3>
    <p>Live Forecast</p>
    </div>
    <div class="feature-card" onclick="showView('water')"><i class="fas fa-tint"></i><h3>Water Advice</h3><p>Irrigation Timing</p></div>
    <div class="feature-card" onclick="showView('pest')"><i class="fas fa-bug"></i><h3>Pest Shield</h3><p>Govt. Alerts</p></div>
</div>
<div id="dashboard-view">
    <h2 style="color:#ff6a00;">Welcome to your Dashboard</h2>
    <p>Select a card to view real-time data.</p>
</div>
<script>
    window.onload = function() {
        const name = localStorage.getItem('savedName');
        if (localStorage.getItem('isLoggedIn') !== 'true') { window.location.href = "login.html"; }
        else { document.getElementById('nav-user').innerHTML = `<span class="namaste-text">Namaste, ${name}!</span><button class="logout-btn" onclick="logout()">Logout</button>`; }
    };
    function logout() { localStorage.removeItem('isLoggedIn'); window.location.href = "login.html"; }

    function showView(type) {
    const view = document.getElementById('dashboard-view');
    
    if (type === 'market') {
        // This restores the Search Bar and Season Dropdown
        view.innerHTML = `
            <h2 class="view-title" style="color:#ff6a00;">Live Mandi Price Explorer</h2>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                <input type="text" id="locationSearch" placeholder="Enter State (e.g. Punjab)" 
                    style="padding:12px; border-radius:10px; border:1px solid #ff6a00; background:#000; color:#fff; width:250px;">
                
                <select id="seasonSelect" style="padding:12px; border-radius:10px; border:1px solid #ff6a00; background:#000; color:#fff;">
                    <option value="Rabi" selected>Rabi (Winter)</option>
                    <option value="Kharif">Kharif (Monsoon)</option>
                    <option value="Zaid">Zaid (Summer)</option>
                </select>

                <button onclick="fetchMandiData()" style="background:#ff6a00; color:#000; font-weight:bold; padding:10px 20px; border-radius:10px; border:none; cursor:pointer;">
                    Search Rates <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="mandi-results">
                </div>
        `;
    } else if (type === 'weather') {
        fetchLiveWeather();
    }
    
}
    // ... [Keep other weather/water/pest cases here]


// 2. Real-Time Data Simulation Function
async function fetchMandiData() {
    const locationInput = document.getElementById('locationSearch').value.trim();
    const resultsArea = document.getElementById('mandi-results');
    
    // CORRECTED API KEY FROM YOUR SCREENSHOT
    const apiKey = "579b464db66ec23bdd000001ef0cf0c9d78145b240df4c7b293b6961"; 

    if(!locationInput) { alert("Please enter a state!"); return; }

    const location = locationInput.charAt(0).toUpperCase() + locationInput.slice(1).toLowerCase();
    resultsArea.innerHTML = `<i class="fas fa-spinner fa-spin" style="font-size:24px; color:#ff6a00;"></i><p>Fetching Live Mandi Data...</p>`;

    try {
        const response = await fetch(`http://localhost:3000/api/mandi?state=${location}&apiKey=${apiKey}`);
        const data = await response.json();

        // Check if data exists and has records
        if (data && data.records && data.records.length > 0) {
            let tableHTML = `
                <table class="data-table" style="width:100%; color:white; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:2px solid #ff6a00;">
                            <th>Crop</th><th>Mandi</th><th>Price (â‚¹/Qtl)</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.records.forEach(item => {
                tableHTML += `
                    <tr style="border-bottom:1px solid #333;">
                        <td style="padding:10px;">${item.commodity}</td>
                        <td>${item.market}</td>
                        <td style="color:#4caf50; font-weight:bold;">â‚¹${item.modal_price}</td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            resultsArea.innerHTML = tableHTML;
        } else {
            resultsArea.innerHTML = `<p style="color:#ff6a00;">No live records found for ${location} right now.</p>`;
        }
    } catch (error) {
        resultsArea.innerHTML = `<p style="color:#f44336;">Backend Error. Ensure 'node server.js' is running in your terminal.</p>`;
    }
}
</script>
</body>
</html>